# Automated SPIRE Registration Job
# Runs after install to register workloads with dynamically discovered agent ID
apiVersion: batch/v1
kind: Job
metadata:
  name: spire-register-workloads
  namespace: {{ .Values.global.namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 10
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: spire-server
      restartPolicy: OnFailure
      initContainers:
      # Wait for SPIRE server and agent to be ready
      - name: wait-for-spire
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "â³ Waiting for SPIRE server to be ready..."
          kubectl wait --for=condition=Ready pod -l app=spire-server -n {{ .Values.global.namespace }} --timeout=120s
          
          echo "â³ Waiting for SPIRE agent to be ready..."
          kubectl wait --for=condition=Ready pod -l app=spire-agent -n {{ .Values.global.namespace }} --timeout=120s
          
          echo "â³ Waiting 30 seconds for agent attestation..."
          sleep 30
          
          echo "âœ… SPIRE infrastructure ready"
      containers:
      - name: register
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          echo "ğŸ” Discovering SPIRE Agent SPIFFE ID..."
          
          # Get the agent's SPIFFE ID from logs (includes dynamic UUID)
          AGENT_ID=$(kubectl logs -n {{ .Values.global.namespace }} daemonset/spire-agent 2>&1 | grep "Node attestation was successful" | tail -1 | sed 's/.*spiffe_id="\([^"]*\)".*/\1/')
          
          if [ -z "$AGENT_ID" ]; then
            echo "âŒ Could not discover agent SPIFFE ID"
            exit 1
          fi
          
          echo "âœ… Agent ID: $AGENT_ID"
          
          # Define all workloads to register
          WORKLOADS="git-collector jira-collector iam-collector siem-collector risk-scorer llm-gateway lms"
          
          echo ""
          echo "ğŸ“ Registering workloads..."
          
          for WORKLOAD in $WORKLOADS; do
            echo "   Registering $WORKLOAD..."
            kubectl exec -n {{ .Values.global.namespace }} deploy/spire-server -- \
              /opt/spire/bin/spire-server entry create \
              -spiffeID spiffe://{{ .Values.global.trustDomain }}/$WORKLOAD \
              -parentID "$AGENT_ID" \
              -selector k8s:ns:{{ .Values.global.namespace }} \
              -selector k8s:sa:${WORKLOAD}-sa 2>/dev/null || echo "     (already exists)"
          done
          
          echo ""
          echo "âœ… Registration complete!"
          echo ""
          echo "ğŸ“‹ Current entries:"
          kubectl exec -n {{ .Values.global.namespace }} deploy/spire-server -- \
            /opt/spire/bin/spire-server entry show 2>/dev/null | head -50
